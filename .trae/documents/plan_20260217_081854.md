# 日记应用调试修复计划

## 问题概述

经过代码审查，发现以下主要问题需要修复：

### 1. 修复 Buffer.from 在服务端的使用

* **文件**: `src/app/api/transcribe/route.ts`

* **问题**: Buffer.from 在 Next.js API 路由中可能不可用

* **修复**: 使用 Uint8Array 和 TextDecoder 替代 Buffer

### 2. 修复 date-fns locale 导入

* **文件**: `src/components/ReviewView.tsx`

* **问题**: date-fns v4+ 版本 locale 导入路径可能不正确

* **修复**: 更新为正确的导入路径 `date-fns/locale/zh-CN`

### 3. 修复 IndexedDB 索引创建

* **文件**: `src/lib/storage.ts`

* **问题**: 嵌套路径索引 `classification.emotionScore` 可能不工作

* **修复**: 移除嵌套索引或使用简单字段

### 4. 修复语音录制 MIME 类型兼容性

* **文件**: `src/components/ChatView.tsx`

* **问题**: `audio/webm` 在 Safari 等浏览器不支持

* **修复**: 动态检测支持的 MIME 类型

### 5. 修复报告生成周数计算

* **文件**: `src/components/ReportView.tsx`

* **问题**: getWeekNumber 计算可能不准确

* **修复**: 使用 date-fns 的 getISOWeek 函数

### 6. 优化 TypeScript 配置

* **文件**: `next.config.ts`

* **问题**: 忽略构建错误可能隐藏问题

* **修复**: 移除 ignoreBuildErrors，修复实际的类型错误

### 7. 添加 .gitignore 规则

* **文件**: `.gitignore`

* **问题**: API 密钥文件可能被提交

* **修复**: 确保 .z-ai-config 被忽略

### 8. 清理重复的 lockfiles

* **问题**: 存在 package-lock.json 和 bun.lock

* **修复**: 根据使用的包管理器删除不需要的 lockfile

## 修复顺序

1. 修复依赖和配置问题（lockfiles、.gitignore）
2. 修复服务端 API 问题（Buffer、IndexedDB）
3. 修复前端组件问题（date-fns、语音录制、周数计算）
4. 运行类型检查并修复类型错误
5. 测试所有功能确保正常工作

